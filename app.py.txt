import streamlit as st
import pandas as pd
import plotly.express as px
import os

# 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
st.set_page_config(layout="wide", page_title="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡", page_icon="âš¡")
st.markdown("""
<style>
    .main {direction: rtl;}
    h1, h2, h3, h4, p, div {text-align: right; font-family: 'Segoe UI', sans-serif;}
    .stDataFrame {width: 100%;}
</style>
""", unsafe_allow_html=True)

st.sidebar.title("ğŸ” Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
page = st.sidebar.radio("Ø§Ù„Ù‚Ø³Ù…:", ["Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©", "Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª (517)", "Ø´Ù…Ø§Ù„ Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©"])

# 2. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø¹Ø¯Ù„Ø© Ù„ØªÙ‚Ø±Ø£ Ù…Ø­Ù„ÙŠØ§Ù‹)
@st.cache_data
def load_stations():
    # ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
    if os.path.exists('Electricity_Stations_Final_Cleaned.xlsx'):
        df = pd.read_excel('Electricity_Stations_Final_Cleaned.xlsx')
        if 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' in df.columns: df['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] = df['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'].fillna('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª')
        else: df['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] = 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
        df['Ø§Ù„Ø¹Ø¯Ø¯'] = 1
        return df
    return None

@st.cache_data
def load_distributors():
    # ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù„Ù ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ xlsx Ø£Ùˆ csv ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 517
    files = [f for f in os.listdir('.') if "517" in f and (f.endswith('.xlsx') or f.endswith('.csv'))]
    if not files: return None, None
    
    path = files[0]
    if path.endswith('.csv'): df = pd.read_csv(path).iloc[:, [1, 2, 3, 4]]
    else: df = pd.read_excel(path).iloc[:, [1, 2, 3, 4]]
        
    df.columns = ['Ø§Ù„Ù‚Ø·Ø§Ø¹', 'Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©', 'Ù…Ø³Ù„Ø³Ù„', 'Ø§Ù„Ù…ÙˆØ²Ø¹']
    df = df.replace('nan', pd.NA).ffill()
    df = df[pd.to_numeric(df['Ù…Ø³Ù„Ø³Ù„'], errors='coerce').notnull()]
    df['Ø§Ù„Ù‚Ø·Ø§Ø¹'] = df['Ø§Ù„Ù‚Ø·Ø§Ø¹'].astype(str).str.strip()
    df['Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©'] = df['Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©'].astype(str).str.strip()
    
    eng_counts = df.groupby('Ø§Ù„Ù‚Ø·Ø§Ø¹')['Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©'].nunique()
    df['Ù‚Ø·Ø§Ø¹_Ù„Ù„Ø±Ø³Ù…'] = df['Ø§Ù„Ù‚Ø·Ø§Ø¹'].apply(lambda x: f"{x} (Ù‡Ù†Ø¯Ø³Ø§Øª: {eng_counts.get(x, 0)})")
    df['Ø¹Ø¯Ø¯_Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª'] = 1
    summary = df.groupby('Ø§Ù„Ù‚Ø·Ø§Ø¹').agg({'Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©': 'nunique', 'Ø§Ù„Ù…ÙˆØ²Ø¹': 'count'}).reset_index()
    summary.columns = ['Ø§Ù„Ù‚Ø·Ø§Ø¹', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª']
    return df, summary

# Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ù…Ø§Ù„
def strict_classify(row, type_cols, col_name):
    # (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    combined = ""
    for col in type_cols:
        val = str(row[col])
        if pd.notna(val) and val != 'nan': combined += val + " "
    
    clean = combined.strip().replace('Ø£','Ø§').replace('Ø©','Ù‡')
    name_clean = str(row[col_name]).strip().replace('Ø£','Ø§').replace('Ø©','Ù‡')
    
    if 'ØºØ±Ù' in clean or 'ØºØ±Ù' in name_clean: return 'ØºØ±ÙØ©'
    if 'ÙƒØ´Ùƒ' in clean: return 'ÙƒØ´Ùƒ'
    if 'Ù‡ÙˆØ§ÙŠ' in clean or 'Ø¹Ù„Ù‚' in clean: return 'Ù‡ÙˆØ§Ø¦ÙŠ'
    return 'ÙƒØ´Ùƒ'

def process_file(path, fname):
    try:
        df_temp = pd.read_excel(path, header=None)
        start = 0
        for idx, row in df_temp.head(30).iterrows():
            s = " ".join(row.astype(str).values)
            if 'Ø§Ø³Ù…' in s and 'Ù…Ø­ÙˆÙ„' in s: start = idx; break
        
        df = pd.read_excel(path, header=start)
        df.columns = df.columns.astype(str).str.strip()
        
        col_name = next((c for c in df.columns if 'Ø§Ø³Ù…' in c or 'Ù…Ø­ÙˆÙ„' in c or 'Ø¨ÙŠØ§Ù†' in c), None)
        type_cols = [c for c in df.columns if 'Ù†ÙˆØ¹' in c or 'ÙƒØ´Ùƒ' in c or 'ØºØ±Ù' in c]
        col_cap = next((c for c in df.columns if 'Ù‚Ø¯Ø±Ø©' in c or 'kva' in c.lower()), None)
        
        if col_name:
            df = df.dropna(subset=[col_name])
            df = df[~df[col_name].astype(str).str.contains('total|Ø§Ø¬Ù…Ø§Ù„ÙŠ', case=False, na=False)]
            df['Ø§Ù„Ù†ÙˆØ¹'] = df.apply(lambda x: strict_classify(x, type_cols, col_name), axis=1)
            if col_cap:
                df['Ø§Ù„Ù‚Ø¯Ø±Ø©'] = pd.to_numeric(df[col_cap].astype(str).str.replace(',','').str.replace(' ',''), errors='coerce').fillna(0)
            else: df['Ø§Ù„Ù‚Ø¯Ø±Ø©'] = 0.0
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø© Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
            owner = 'Ù…Ù„Ùƒ Ø§Ù„Ø´Ø±ÙƒØ©' if 'Ø´Ø±ÙƒÙ‡' in fname else ('Ù…Ù„Ùƒ Ø§Ù„ØºÙŠØ±' if 'ØºÙŠØ±' in fname else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')
            if 'Ø²Ø§ÙŠØ¯' in fname: eng = 'Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯'
            elif 'Ø§ÙˆÙ„' in fname: eng = 'Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ© Ø£ÙˆÙ„'
            elif 'Ø«Ø§Ù†' in fname: eng = 'Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ© Ø«Ø§Ù†'
            else: eng = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
            
            return pd.DataFrame({'Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©': eng, 'Ø§Ù„Ù…Ù„ÙƒÙŠØ©': owner, 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„': df[col_name], 'Ø§Ù„Ù†ÙˆØ¹': df['Ø§Ù„Ù†ÙˆØ¹'], 'Ø§Ù„Ù‚Ø¯Ø±Ø©': df['Ø§Ù„Ù‚Ø¯Ø±Ø©']})
    except: return None

@st.cache_data
def load_north():
    folder = 'North_Ismailia_Files' # Ù‡Ù†Ø§ ÙŠÙ‚Ø±Ø£ Ù…Ù† Ø§Ù„ÙÙˆÙ„Ø¯Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
    if not os.path.exists(folder): return None
    all_dfs = []
    for f in os.listdir(folder):
        if f.endswith(('.xls','.xlsx')) and not f.startswith('~$'):
            res = process_file(os.path.join(folder, f), f)
            if res is not None: all_dfs.append(res)
    if all_dfs:
        df = pd.concat(all_dfs)
        df['Ø§Ù„Ù‚Ø·Ø§Ø¹'] = 'Ø´Ù…Ø§Ù„ Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©'
        return df
    return None

# 3. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
if page == "Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©":
    st.header("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­Ø·Ø§Øª")
    df = load_stations()
    if df is not None:
        fig1 = px.sunburst(df, path=['Ø§Ù„Ù‚Ø·Ø§Ø¹', 'Ø§Ù„Ù…Ø­Ø·Ø©'], values='Ø§Ù„Ø¹Ø¯Ø¯', height=600, hover_data={'Ù…Ù„Ø§Ø­Ø¸Ø§Øª':True})
        st.plotly_chart(fig1, use_container_width=True)
        
        cnt = df['Ø§Ù„Ù‚Ø·Ø§Ø¹'].value_counts().reset_index()
        cnt.columns = ['Ø§Ù„Ù‚Ø·Ø§Ø¹', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª']
        fig2 = px.bar(cnt, x='Ø§Ù„Ù‚Ø·Ø§Ø¹', y='Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª', color='Ø§Ù„Ù‚Ø·Ø§Ø¹', text='Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª')
        fig2.update_traces(textposition='outside')
        st.plotly_chart(fig2, use_container_width=True)
        st.dataframe(df, use_container_width=True)
    else: st.error("Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø·Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯! ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹Ù‡.")

elif page == "Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª (517)":
    st.header("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª")
    df, summ = load_distributors()
    if df is not None:
        st.dataframe(summ, use_container_width=True)
        fig_sun = px.sunburst(df, path=['Ù‚Ø·Ø§Ø¹_Ù„Ù„Ø±Ø³Ù…','Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©','Ø§Ù„Ù…ÙˆØ²Ø¹'], values='Ø¹Ø¯Ø¯_Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª', height=600)
        st.plotly_chart(fig_sun, use_container_width=True)
        
        cnt = df.groupby(['Ø§Ù„Ù‚Ø·Ø§Ø¹','Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©']).size().reset_index(name='Ø§Ù„Ø¹Ø¯Ø¯').sort_values('Ø§Ù„Ø¹Ø¯Ø¯', ascending=False)
        fig_bar = px.bar(cnt, x='Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©', y='Ø§Ù„Ø¹Ø¯Ø¯', color='Ø§Ù„Ù‚Ø·Ø§Ø¹', text='Ø§Ù„Ø¹Ø¯Ø¯')
        fig_bar.update_traces(textposition='outside', cliponaxis=False)
        st.plotly_chart(fig_bar, use_container_width=True)
    else: st.error("Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ²Ø¹Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")

elif page == "Ø´Ù…Ø§Ù„ Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©":
    st.header("Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„")
    df = load_north()
    if df is not None:
        k1,k2 = st.columns(2)
        k1.metric("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¯Ø±Ø©", f"{df['Ø§Ù„Ù‚Ø¯Ø±Ø©'].sum():,.0f}")
        k2.metric("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ÙˆÙ„Ø§Øª", len(df))
        
        fig_main = px.bar(df.groupby(['Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©','Ø§Ù„Ù…Ù„ÙƒÙŠØ©'])['Ø§Ù„Ù‚Ø¯Ø±Ø©'].sum().reset_index(), x='Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©', y='Ø§Ù„Ù‚Ø¯Ø±Ø©', color='Ø§Ù„Ù…Ù„ÙƒÙŠØ©', text='Ø§Ù„Ù‚Ø¯Ø±Ø©', barmode='group')
        fig_main.update_traces(textposition='outside')
        st.plotly_chart(fig_main, use_container_width=True)
        
        fig_sun = px.sunburst(df[df['Ø§Ù„Ù‚Ø¯Ø±Ø©']>0], path=['Ø§Ù„Ù‚Ø·Ø§Ø¹','Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©','Ø§Ù„Ù…Ù„ÙƒÙŠØ©','Ø§Ù„Ù†ÙˆØ¹','Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„'], values='Ø§Ù„Ù‚Ø¯Ø±Ø©')
        st.plotly_chart(fig_sun, use_container_width=True)
        st.dataframe(df, use_container_width=True)
    else: st.error("ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙÙˆÙ„Ø¯Ø± North_Ismailia_Files ÙˆØ¯Ø§Ø®Ù„Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª.")